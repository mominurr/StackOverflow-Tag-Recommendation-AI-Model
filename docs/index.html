<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StackOverflow Tag Predictor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tag-pill {
            transition: all 0.2s ease;
        }
        .tag-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col">

    <!-- Header (Updated with user content) -->
    <header class="bg-white shadow-sm border-b border-gray-200 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center justify-center gap-3 mb-2">
                <span class="text-4xl">ü§ñ</span>
                StackOverflow Tag Predictor - AI Model
            </h1>
            <p class="text-lg text-gray-500">AI-powered tag recommendations for your programming questions</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- Info Card (Added) -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8 shadow-sm">
            <h2 class="text-lg font-semibold text-gray-900 mb-2 flex items-center gap-2">
                <span class="text-xl">‚ÑπÔ∏è</span> How it works
            </h2>
            <p class="text-gray-700 leading-relaxed">
                Enter your programming question below (including code snippets). Our AI model analyzes the full context to predict the most relevant StackOverflow tags.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Column: Input -->
            <div class="lg:col-span-5 space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa-regular fa-pen-to-square text-blue-500"></i> Input Question
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="question" class="block text-sm font-medium text-gray-700 mb-1">Question Text</label>
                            <textarea id="question" rows="6" 
                                class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all resize-none text-gray-700 placeholder-gray-400"
                                placeholder="e.g., How do I read a CSV file in Python using pandas?"></textarea>
                        </div>

                        <!-- Controls -->
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <label for="threshold" class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">
                                    Confidence (> <span id="threshold-val">0.3</span>)
                                </label>
                                <input type="range" id="threshold" min="0.1" max="0.9" step="0.05" value="0.3" 
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                            </div>
                            <div>
                                <label for="top_k" class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">
                                    Max Tags (<span id="top_k-val">10</span>)
                                </label>
                                <input type="range" id="top_k" min="1" max="20" step="1" value="10" 
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                            </div>
                        </div>

                        <button id="predict-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg transform active:scale-[0.98]">
                            <span id="btn-text">Predict Tags</span>
                            <div id="btn-loader" class="loader hidden"></div>
                        </button>
                    </div>
                </div>

                <!-- Examples Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Try an Example</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-full transition-colors"
                            data-text="How do I read a CSV file in Python using pandas?">
                            CSV in Python
                        </button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-full transition-colors"
                            data-text="What is the difference between let and var in JavaScript?">
                            JS let vs var
                        </button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-full transition-colors"
                            data-text="How to center a div horizontally and vertically in CSS?">
                            Center Div CSS
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Output -->
            <div class="lg:col-span-7">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 h-full flex flex-col">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 border-b border-gray-100 pb-2">
                        <i class="fa-solid fa-tags text-green-500"></i> Predictions
                    </h2>
                    
                    <!-- Content Area -->
                    <div id="result-area" class="flex-grow flex flex-col items-center justify-center text-center p-4">
                        <!-- Initial State -->
                        <div id="empty-state" class="text-gray-400">
                            <i class="fa-brands fa-searchengin text-6xl mb-4 opacity-20"></i>
                            <p class="text-lg">Enter a question and hit predict to see tags.</p>
                        </div>
                        
                        <!-- Results Container (Hidden initially) -->
                        <div id="tags-container" class="w-full hidden space-y-4 text-left">
                            <div id="status-msg" class="hidden p-3 rounded-lg text-sm mb-4"></div>
                            
                            <div id="tags-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <!-- Tags will be injected here -->
                            </div>

                            <!-- Raw JSON Toggle -->
                            <div class="mt-8 pt-4 border-t border-gray-100">
                                <button onclick="toggleJson()" class="text-xs text-gray-400 hover:text-blue-500 flex items-center gap-1">
                                    <i class="fa-solid fa-code"></i> View Raw Response
                                </button>
                                <pre id="raw-json" class="hidden mt-2 p-3 bg-gray-900 text-green-400 rounded text-xs overflow-x-auto"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer (New) -->
    <footer class="bg-white border-t border-gray-200 py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 flex flex-col items-center justify-center text-center">
            <p class="text-gray-600 font-medium mb-4">Built with ‚ù§Ô∏è using Hugging Face, PyTorch and Gradio</p>
            <div class="flex items-center gap-6">
                <a href="https://github.com/mominurr/StackOverflow-Tag-Recommendation-AI-Model" target="_blank" 
                   class="flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors px-3 py-2 rounded-lg hover:bg-gray-50">
                    <span class="text-xl">üì¶</span> 
                    <span class="font-medium">GitHub</span>
                </a>
                <a href="https://huggingface.co/spaces/mominur-ai/StackOverflow-Tag-Recommendation-AI-Model" target="_blank"
                   class="flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors px-3 py-2 rounded-lg hover:bg-gray-50">
                    <span class="text-xl">ü§ó</span> 
                    <span class="font-medium">Model Space</span>
                </a>
            </div>
        </div>
    </footer>

    <!-- Logic -->
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";

        // Configuration
        const HF_SPACE_ID = "mominur-ai/StackOverflow-Tag-Recommendation-AI-Model"; 
        
        // DOM Elements
        const questionInput = document.getElementById('question');
        const thresholdInput = document.getElementById('threshold');
        const topKInput = document.getElementById('top_k');
        const predictBtn = document.getElementById('predict-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        
        const tagsContainer = document.getElementById('tags-container');
        const tagsList = document.getElementById('tags-list');
        const emptyState = document.getElementById('empty-state');
        const rawJson = document.getElementById('raw-json');
        const statusMsg = document.getElementById('status-msg');

        // Update Slider Values UI
        thresholdInput.addEventListener('input', (e) => document.getElementById('threshold-val').textContent = e.target.value);
        topKInput.addEventListener('input', (e) => document.getElementById('top_k-val').textContent = e.target.value);

        // Handle Examples
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                questionInput.value = btn.dataset.text;
            });
        });

        // Main Predict Function
        async function predictTags() {
            const question = questionInput.value.trim();
            
            if (!question) {
                alert("Please enter a question first.");
                return;
            }

            // UI Loading State
            setLoading(true);
            tagsContainer.classList.add('hidden');
            emptyState.classList.add('hidden');
            statusMsg.classList.add('hidden');

            try {
                // Connect to the Space
                const client = await Client.connect(HF_SPACE_ID);
                
                // Call the API endpoint we exposed in app.py
                // API Name: "/predict_tags_api" (Updated)
                const result = await client.predict("/predict_tags_api", { 
                    question: question, 
                    threshold: parseFloat(thresholdInput.value), 
                    top_k: parseInt(topKInput.value) 
                });

                const data = result.data[0]; // Gradio wraps return in an array
                renderResults(data);

            } catch (error) {
                console.error("Error:", error);
                showError("Failed to connect to the model. " + error.message);
            } finally {
                setLoading(false);
            }
        }

        function renderResults(data) {
            tagsContainer.classList.remove('hidden');
            tagsList.innerHTML = ''; // Clear previous
            rawJson.textContent = JSON.stringify(data, null, 2);

            let predictions = [];
            let status = 'success';
            let message = '';

            // --- SMART FALLBACK LOGIC ---
            // Case 1: JSON Response (New app.py deployed)
            if (typeof data === 'object' && data.predictions) {
                predictions = data.predictions;
                status = data.status;
                message = data.message;
            } 
            // Case 2: String/Markdown Response (Old app.py currently live)
            else if (typeof data === 'string') {
                // Regex Parse: looks for "**tag**: 99.99%"
                const regex = /\*\*(.*?)\*\*: ([\d.]+)%/g;
                let match;
                while ((match = regex.exec(data)) !== null) {
                    predictions.push({
                        tag: match[1],
                        confidence: parseFloat(match[2]) / 100 // Convert percentage back to decimal
                    });
                }
                
                if (predictions.length > 0) {
                    status = 'success';
                    message = `Found ${predictions.length} tags (Parsed from text)`;
                } else if (data.includes("‚ö†Ô∏è")) {
                     status = 'error';
                     message = data.replace("‚ö†Ô∏è", "").trim();
                } else {
                    status = 'info';
                    message = "Could not parse tags from response.";
                }
            }

            // --- RENDERING ---

            if (status === 'error') {
                showError(message);
                return;
            }

            if (!predictions || predictions.length === 0) {
                showInfo(message || "No tags found matching criteria.");
                return;
            }

            // Success Message
            statusMsg.className = "bg-green-50 text-green-700 p-3 rounded-lg text-sm mb-4 border border-green-200 block";
            statusMsg.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> ${message}`;

            // Render Tags
            predictions.forEach(pred => {
                const percentage = (pred.confidence * 100).toFixed(1);
                
                const card = document.createElement('div');
                card.className = "tag-pill bg-white border border-gray-200 rounded-lg p-3 flex items-center justify-between hover:border-blue-300";
                
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2.5 py-1 rounded border border-blue-200">
                            ${pred.tag}
                        </span>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-sm font-bold text-gray-700">${percentage}%</span>
                        <div class="w-24 h-1.5 bg-gray-100 rounded-full mt-1 overflow-hidden">
                            <div class="h-full bg-blue-500 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
                tagsList.appendChild(card);
            });
        }

        function setLoading(isLoading) {
            if (isLoading) {
                predictBtn.disabled = true;
                predictBtn.classList.add('opacity-75', 'cursor-not-allowed');
                btnText.textContent = "Analyzing...";
                btnLoader.classList.remove('hidden');
            } else {
                predictBtn.disabled = false;
                predictBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.textContent = "Predict Tags";
                btnLoader.classList.add('hidden');
            }
        }

        function showError(msg) {
            tagsContainer.classList.remove('hidden');
            statusMsg.className = "bg-red-50 text-red-700 p-3 rounded-lg text-sm mb-4 border border-red-200 block";
            statusMsg.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i> ${msg}`;
        }

        function showInfo(msg) {
            tagsContainer.classList.remove('hidden');
            statusMsg.className = "bg-yellow-50 text-yellow-700 p-3 rounded-lg text-sm mb-4 border border-yellow-200 block";
            statusMsg.innerHTML = `<i class="fa-solid fa-circle-info mr-2"></i> ${msg}`;
        }

        // Attach Click Handler
        predictBtn.addEventListener('click', predictTags);
        
        // Global scope for HTML button calls
        window.toggleJson = () => {
            const el = document.getElementById('raw-json');
            el.classList.toggle('hidden');
        };

    </script>
</body>
</html>